<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫ËÉΩ‰∏≠ÊñáÁªÉ‰π† - AI-Powered Chinese Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .app-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .ai-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
            margin-top: 10px;
        }

        .main-content {
            padding: 30px;
        }

        .setup-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .setup-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .setup-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .setup-input {
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .setup-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .setup-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .setup-button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .setup-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .connection-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .connection-status.disconnected {
            background: #dc3545;
            color: white;
        }

        .connection-status.testing {
            background: #ffc107;
            color: #212529;
        }

        .connection-status.connected {
            background: #28a745;
            color: white;
        }

        .ai-features {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .ai-toggle {
            background: #e9ecef;
            color: #495057;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-toggle:hover {
            background: #dee2e6;
        }

        .ai-toggle.enabled {
            background: #d4edda;
            color: #155724;
        }

        .ai-toggle.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .score {
            font-size: 1.1em;
            font-weight: bold;
            color: #28a745;
        }

        .question-count {
            font-size: 1.1em;
            color: #6c757d;
        }

        .question-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .question-text {
            font-size: 2em;
            color: #333;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 5px solid #007bff;
        }

        .question-audio {
            margin-top: 20px;
        }

        .audio-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
        }

        .audio-btn:hover {
            background: #138496;
            transform: translateY(-1px);
        }

        .answer-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .answer-display {
            font-size: 1.4em;
            min-height: 60px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .answer-display.correct {
            border-color: #28a745;
            background: #d4edda;
        }

        .answer-display.improvable {
            border-color: #ffc107;
            background: #fff3cd;
        }

        .answer-display.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .controls {
            text-align: center;
        }

        .record-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .record-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .record-btn.recording {
            background: #28a745;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .ai-analysis {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .ai-analysis.active {
            display: block;
        }

        .feedback {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .feedback.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .feedback.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .next-controls {
            text-align: center;
            margin-top: 20px;
        }

        .next-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .next-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .app-container {
                margin: 10px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .setup-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .ai-features {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>Êô∫ËÉΩ‰∏≠ÊñáÁªÉ‰π†</h1>
            <p>AI-Powered Mandarin Practice</p>
            <div class="ai-badge">ü§ñ Powered by MiniMax AI</div>
        </div>

        <div class="main-content">
            <!-- AI Setup Section -->
            <div class="setup-section">
                <h3>üöÄ API Configuration</h3>
                <div class="setup-controls">
                    <input type="password" id="apiKeyInput" class="setup-input" 
                           placeholder="Enter your MiniMax API key" 
                           value="eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJHcm91cE5hbWUiOiJZb3UgRmlyc3QhIGlkaW9tYXMiLCJVc2VyTmFtZSI6IllvdUZpc3NIdGlvbWFzLmNvbSIsIkFjY291bnQiOiIiLCJzdWJqZWN0SWQiOiIxOTg4NTY5NDYwNDc0MTI2NTIxIiwiUGhvbmUiOiIiLCJHcm91cElEIjoiMTk4ODU2OTQ2MDQ2OTkyODEyMSIsIlBhZ2VOYW1lIjoiIiwibWFpbCI6InlvdWZpcnN0aWRpb21hc0BnbWFpbC5jb20iLCJDcmVhdGVUaW1lIjoiMjAyNS0xMS0xMyAwMjo0ODozNiIsIlRva2VuVHlwZSI6MSwiaXNzIjoibWluaW1heCJ9.dVcKOAilY4y2cNN5LJtNyXlqGRkt0oGAS0a2vCCF6wFuqTCUFkBvYbWZjCjLV9abDi5wZL9wVRiclmm5K11CMfVUlVSG7ne_MDc7wfw0UT6ceosKXBM65Ia_pcljjgWO5a_VH8R4gjV10nk5CwZoWo3LJ7_ASZerfUwEOXwAU0_p6RVcVUL9NtH0tlRyyQsq9VFafoXSL_IMU3xB3Ca_dU2aS4JeQOfJkUogNIw0rgAT6nmtnldWSiiUSSbrnTj05V7c568egFtW5FAk1JFL09Tkuq769aOBd6wlWSgMtzqcPB00wli4MeRwrwaykHPRwC0VkZ2Amvc1tDykg825xg"
                           style="flex: 1; min-width: 300px;">
                    <button id="testConnection" class="setup-button">Test Connection</button>
                    <div id="connectionStatus" class="connection-status disconnected">Disconnected</div>
                </div>
                <div class="ai-features">
                    <button id="generateQuestions" class="ai-toggle disabled" disabled>
                        üéØ Generate AI Questions
                    </button>
                    <button id="aiAnalysis" class="ai-toggle disabled" disabled>
                        üß† AI Analysis
                    </button>
                    <button id="debugInfo" class="ai-toggle">
                        üîç Debug Info
                    </button>
                </div>
                <div id="debugPanel" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4>Debug Information:</h4>
                    <div id="debugContent" style="font-family: monospace; font-size: 0.9em; color: #666;"></div>
                </div>
            </div>

            <div class="progress">
                <div class="score">Score: <span id="score">0</span></div>
                <div class="question-count">Question <span id="currentQuestion">1</span>/20</div>
            </div>

            <div class="question-section">
                <div id="questionText" class="question-text">ÁÇπÂáªÂºÄÂßãÁªÉ‰π† (Click to start practicing)</div>
                <div id="questionAudio" class="question-audio" style="display: none;">
                    <button class="audio-btn" id="playAudio">üîä Play Question Audio</button>
                    <button class="audio-btn" id="repeatQuestion">üîÑ Repeat Question</button>
                </div>
            </div>

            <div class="answer-section">
                <div id="answerDisplay" class="answer-display">
                    ÁÇπÂáªÂºÄÂßãÂΩïÈü≥ËØ¥‰∏≠Êñá (Click to start recording in Chinese)
                </div>
                <div class="controls">
                    <button class="record-btn" id="startRecording">üé§ Start Recording</button>
                </div>
            </div>

            <div id="aiAnalysisSection" class="ai-analysis"></div>
            
            <div class="next-controls">
                <button class="next-btn" id="nextQuestion" style="display: none;">Next Question</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * MiniMax API Integration Class - CORRECTED VERSION
         * Fixed: Correct API URL and better error handling
         */
        class MiniMaxIntegration {
            constructor(apiKey, options = {}) {
                this.apiKey = apiKey;
                this.baseURL = 'https://api.minimax.io/v1'; // CORRECTED URL
                this.options = {
                    model: options.model || 'abab6.5s-chat',
                    temperature: options.temperature || 0.7,
                    maxTokens: options.maxTokens || 1000,
                    timeout: options.timeout || 30000,
                    ...options
                };
                
                this.requestQueue = [];
                this.isProcessing = false;
                this.rateLimiter = {
                    requests: 0,
                    resetTime: Date.now() + 60000
                };
            }

            /**
             * Test connection to MiniMax API
             */
            async testConnection() {
                console.log('Testing MiniMax connection...', {
                    apiKey: this.apiKey ? `${this.apiKey.substring(0, 8)}...` : 'Not provided',
                    baseURL: this.baseURL,
                    model: this.options.model
                });

                try {
                    const response = await this.makeRequest('/text/chatcompletion_v2', {
                        model: this.options.model,
                        messages: [
                            {
                                role: 'user',
                                content: 'ËØ∑ÂõûÂ§ç"ËøûÊé•ÊàêÂäü"'
                            }
                        ],
                        max_tokens: 50,
                        temperature: 0.1
                    });
                    
                    console.log('Connection test response:', response);
                    
                    return {
                        success: true,
                        response: response.choices[0].message.content,
                        timestamp: new Date().toISOString()
                    };
                } catch (error) {
                    console.error('Connection test failed:', error);
                    return {
                        success: false,
                        error: error.message,
                        details: error.toString(),
                        timestamp: new Date().toISOString()
                    };
                }
            }

            /**
             * Generate questions using AI
             */
            async generateQuestions(userLevel, topic, difficulty = 'beginner', count = 5) {
                const prompt = `‰Ωú‰∏∫‰∏≠ÊñáËØ≠Ë®ÄËÄÅÂ∏àÔºå‰∏∫HSK ${userLevel}Á∫ßÂà´Â≠¶ÁîüÂàõÂª∫ÂÖ≥‰∫é"${topic}"‰∏ªÈ¢òÁöÑ${count}‰∏™ÁªÉ‰π†ÈóÆÈ¢ò„ÄÇ
                
Ë¶ÅÊ±ÇÔºö
- Âè™‰ΩøÁî®‰∏≠ÊñáÁÆÄ‰ΩìÂ≠óÔºå‰∏çË¶ÅÊãºÈü≥
- ÈöæÂ∫¶Ôºö${difficulty}
- ÊØè‰∏™ÈóÆÈ¢òÈÉΩË¶ÅÊúâÊòéÁ°ÆÁöÑÁªÉ‰π†ÁõÆÁöÑ
- ÈóÆÈ¢òË¶ÅËá™ÁÑ∂ÂÆûÁî®

ËØ∑‰ª•JSONÊ†ºÂºèËøîÂõûÔºö
{
    "questions": [
        {
            "text": "ÈóÆÈ¢òÂÜÖÂÆπ",
            "expected_answer": "È¢ÑÊúüÂõûÁ≠îÁ§∫‰æã",
            "category": "ÂàÜÁ±ª",
            "context": "‰ΩøÁî®Âú∫ÊôØ"
        }
    ]
}`;

                try {
                    const response = await this.makeRequest('/text/chatcompletion_v2', {
                        model: this.options.model,
                        messages: [
                            {
                                role: 'system',
                                content: '‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑHSK‰∏≠ÊñáËÄÅÂ∏àÔºåÊìÖÈïøÂàõÂª∫ÂÆûÁî®ÁöÑÁªÉ‰π†ÈóÆÈ¢ò„ÄÇ'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: this.options.temperature,
                        max_tokens: this.options.maxTokens
                    });

                    const content = response.choices[0].message.content;
                    console.log('Generated questions:', content);
                    
                    // Try to parse JSON response
                    try {
                        const jsonStart = content.indexOf('{');
                        const jsonEnd = content.lastIndexOf('}');
                        if (jsonStart >= 0 && jsonEnd >= 0) {
                            const jsonContent = content.substring(jsonStart, jsonEnd + 1);
                            const result = JSON.parse(jsonContent);
                            return result.questions || [];
                        }
                    } catch (parseError) {
                        console.warn('Failed to parse JSON, using fallback');
                    }
                    
                    // Fallback: extract questions from text
                    return this.parseQuestionsFromText(content, count);
                    
                } catch (error) {
                    console.error('Error generating questions:', error);
                    return this.getFallbackQuestions(topic, difficulty, count);
                }
            }

            /**
             * Make API request with error handling
             */
            async makeRequest(endpoint, data) {
                await this.checkRateLimit();

                const requestUrl = `${this.baseURL}${endpoint}`;
                
                console.log('Making request to:', requestUrl);
                
                const requestBody = JSON.stringify({
                    ...data,
                    stream: false
                });

                console.log('Request body:', requestBody);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), this.options.timeout);

                try {
                    const response = await fetch(requestUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKey}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: requestBody,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    console.log('Response status:', response.status, response.statusText);
                    console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error Response:', errorText);
                        throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                    }

                    const result = await response.json();
                    console.log('API Response:', result);
                    
                    if (result.error) {
                        throw new Error(result.error.message || result.error.type || 'API Error');
                    }

                    return result;
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('Request timeout');
                    }
                    console.error('Request failed:', error);
                    throw error;
                }
            }

            /**
             * Check rate limiting
             */
            async checkRateLimit() {
                const now = Date.now();
                if (now > this.rateLimiter.resetTime) {
                    this.rateLimiter.requests = 0;
                    this.rateLimiter.resetTime = now + 60000;
                }
                
                if (this.rateLimiter.requests >= 60) {
                    const waitTime = this.rateLimiter.resetTime - now;
                    console.log(`Rate limit reached, waiting ${waitTime}ms`);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }

            /**
             * Parse questions from text response
             */
            parseQuestionsFromText(text, count) {
                const questions = [];
                const lines = text.split('\n');
                
                for (const line of lines) {
                    if (line.trim() && questions.length < count) {
                        questions.push({
                            text: line.trim(),
                            expected_answer: '',
                            category: 'general',
                            context: 'conversation'
                        });
                    }
                }
                
                return questions.length > 0 ? questions : this.getFallbackQuestions('general', 'beginner', count);
            }

            /**
             * Fallback questions when API fails
             */
            getFallbackQuestions(topic, difficulty, count) {
                return [
                    {
                        text: `‰Ω†Â•ΩÔºåÂæàÈ´òÂÖ¥ËÆ§ËØÜ‰Ω†„ÄÇ‰Ω†Â•ΩÂêóÔºü`,
                        expected_answer: `ÊàëÂæàÂ•ΩÔºåË∞¢Ë∞¢„ÄÇ‰Ω†Âë¢Ôºü`,
                        category: 'greeting',
                        context: 'meeting someone new'
                    },
                    {
                        text: `‰Ω†Âè´‰ªÄ‰πàÂêçÂ≠óÔºü`,
                        expected_answer: `ÊàëÂè´...`,
                        category: 'introduction',
                        context: 'personal introduction'
                    },
                    {
                        text: `‰Ω†Êù•Ëá™Âì™ÈáåÔºü`,
                        expected_answer: `ÊàëÊù•Ëá™...`,
                        category: 'origin',
                        context: 'talking about background'
                    }
                ].slice(0, count);
            }
        }

        /**
         * Main Application Class
         */
        class ChinesePracticeApp {
            constructor() {
                this.currentQuestion = 0;
                this.score = 0;
                this.isRecording = false;
                this.recognition = null;
                this.minimaxAPI = null;
                this.aiEnabled = false;
                this.questions = [];
                this.currentTranscript = '';
                
                this.initializeApp();
            }

            async initializeApp() {
                this.setupEventListeners();
                this.initializeSpeechRecognition();
                this.loadQuestions();
                
                // Auto-load saved API key
                const savedApiKey = localStorage.getItem('minimax_api_key');
                if (savedApiKey) {
                    document.getElementById('apiKeyInput').value = savedApiKey;
                }
            }

            setupEventListeners() {
                // AI Setup
                document.getElementById('testConnection').addEventListener('click', () => {
                    this.testMiniMaxConnection();
                });

                document.getElementById('generateQuestions').addEventListener('click', () => {
                    this.generateAIQuestions();
                });

                document.getElementById('debugInfo').addEventListener('click', () => {
                    this.toggleDebugPanel();
                });

                // Recording
                document.getElementById('startRecording').addEventListener('click', () => {
                    this.toggleRecording();
                });

                // Navigation
                document.getElementById('nextQuestion').addEventListener('click', () => {
                    this.nextQuestion();
                });

                document.getElementById('playAudio').addEventListener('click', () => {
                    this.playQuestionAudio();
                });

                document.getElementById('repeatQuestion').addEventListener('click', () => {
                    this.playQuestionAudio();
                });
            }

            initializeSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    
                    this.recognition.continuous = true;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'zh-CN';
                    
                    this.recognition.onresult = (event) => {
                        let finalTranscript = '';
                        let interimTranscript = '';
                        
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript;
                            } else {
                                interimTranscript += transcript;
                            }
                        }
                        
                        this.currentTranscript = finalTranscript || interimTranscript;
                        this.updateAnswerDisplay();
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.stopRecording();
                    };
                    
                    this.recognition.onend = () => {
                        if (this.isRecording) {
                            this.recognition.start(); // Restart if still recording
                        }
                    };
                } else {
                    console.warn('Speech recognition not supported');
                }
            }

            async testMiniMaxConnection() {
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                
                if (!apiKey) {
                    this.showFeedback('error', 'API Key Required', 'Please enter your MiniMax API key');
                    return;
                }

                // Update UI
                const statusElement = document.getElementById('connectionStatus');
                statusElement.textContent = 'Testing...';
                statusElement.className = 'connection-status testing';

                try {
                    this.minimaxAPI = new MiniMaxIntegration(apiKey);
                    const result = await this.minimaxAPI.testConnection();
                    
                    if (result.success) {
                        this.aiEnabled = true;
                        statusElement.textContent = 'Connected ‚úì';
                        statusElement.className = 'connection-status connected';
                        
                        // Save API key
                        localStorage.setItem('minimax_api_key', apiKey);
                        
                        // Enable AI features
                        this.enableAIFeatures();
                        
                        this.showFeedback('success', 'AI Connected!', 
                            `Connection successful! API responded: "${result.response}"`);
                            
                        this.updateDebugInfo('Connection successful', result);
                        
                    } else {
                        throw new Error(result.error || 'Unknown error');
                    }
                } catch (error) {
                    console.error('Connection test failed:', error);
                    statusElement.textContent = 'Failed ‚úó';
                    statusElement.className = 'connection-status disconnected';
                    
                    this.showFeedback('error', 'Connection Failed', 
                        `Error: ${error.message}. Please check your API key and internet connection.`);
                        
                    this.updateDebugInfo('Connection failed', { error: error.message, details: error.toString() });
                }
            }

            enableAIFeatures() {
                const aiButtons = ['generateQuestions', 'aiAnalysis'];
                aiButtons.forEach(buttonId => {
                    const button = document.getElementById(buttonId);
                    button.classList.remove('disabled');
                    button.disabled = false;
                    button.classList.add('enabled');
                });
            }

            toggleDebugPanel() {
                const panel = document.getElementById('debugPanel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }

            updateDebugInfo(title, data) {
                const debugContent = document.getElementById('debugContent');
                const timestamp = new Date().toLocaleTimeString();
                debugContent.innerHTML = `
                    <div><strong>${timestamp} - ${title}:</strong></div>
                    <div>${JSON.stringify(data, null, 2)}</div>
                    <hr style="margin: 10px 0;">
                ` + debugContent.innerHTML;
            }

            showFeedback(type, title, message) {
                const feedback = document.createElement('div');
                feedback.className = `feedback ${type}`;
                feedback.innerHTML = `
                    <strong>${title}</strong><br>
                    ${message}
                `;
                
                const mainContent = document.querySelector('.main-content');
                mainContent.insertBefore(feedback, mainContent.firstChild);
                
                setTimeout(() => {
                    feedback.remove();
                }, 5000);
            }

            updateAnswerDisplay() {
                const display = document.getElementById('answerDisplay');
                if (this.currentTranscript) {
                    display.textContent = this.currentTranscript || 'Ê≠£Âú®ËØÜÂà´...';
                } else {
                    display.textContent = 'ÁÇπÂáªÂºÄÂßãÂΩïÈü≥ËØ¥‰∏≠Êñá (Click to start recording in Chinese)';
                }
            }

            toggleRecording() {
                if (!this.recognition) {
                    this.showFeedback('error', 'Not Supported', 'Speech recognition is not supported in this browser');
                    return;
                }

                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    this.startRecording();
                }
            }

            startRecording() {
                try {
                    this.currentTranscript = '';
                    this.recognition.start();
                    this.isRecording = true;
                    
                    const button = document.getElementById('startRecording');
                    button.textContent = 'üî¥ Stop Recording';
                    button.classList.add('recording');
                    
                    this.updateAnswerDisplay();
                    
                    this.showFeedback('info', 'Recording Started', 'Speak in Chinese now...');
                } catch (error) {
                    console.error('Failed to start recording:', error);
                    this.showFeedback('error', 'Recording Error', 'Failed to start recording: ' + error.message);
                }
            }

            stopRecording() {
                if (this.recognition) {
                    this.recognition.stop();
                }
                
                this.isRecording = false;
                
                const button = document.getElementById('startRecording');
                button.textContent = 'üé§ Start Recording';
                button.classList.remove('recording');
                
                // Show next question button after a brief delay
                setTimeout(() => {
                    document.getElementById('nextQuestion').style.display = 'inline-block';
                }, 1000);
            }

            nextQuestion() {
                this.currentQuestion++;
                
                if (this.currentQuestion >= this.questions.length) {
                    this.showFeedback('success', 'Practice Complete!', 
                        `Great job! Your final score: ${this.score}/${this.questions.length}`);
                    return;
                }
                
                this.displayCurrentQuestion();
                document.getElementById('nextQuestion').style.display = 'none';
            }

            displayCurrentQuestion() {
                const question = this.questions[this.currentQuestion];
                document.getElementById('questionText').textContent = question.text;
                document.getElementById('currentQuestion').textContent = this.currentQuestion + 1;
                document.getElementById('answerDisplay').textContent = 
                    'ÁÇπÂáªÂºÄÂßãÂΩïÈü≥ËØ¥‰∏≠Êñá (Click to start recording in Chinese)';
                this.currentTranscript = '';
            }

            playQuestionAudio() {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(
                        this.questions[this.currentQuestion].text
                    );
                    utterance.lang = 'zh-CN';
                    utterance.rate = 0.8;
                    speechSynthesis.speak(utterance);
                }
            }

            async generateAIQuestions() {
                if (!this.aiEnabled || !this.minimaxAPI) {
                    this.showFeedback('error', 'AI Not Available', 'Please connect to AI first');
                    return;
                }

                this.showFeedback('info', 'Generating Questions', 'Creating AI-powered questions...');

                try {
                    const aiQuestions = await this.minimaxAPI.generateQuestions(
                        '1-2', // HSK level
                        'daily conversation', // topic
                        'beginner', // difficulty
                        5 // count
                    );

                    if (aiQuestions.length > 0) {
                        this.questions = aiQuestions;
                        this.currentQuestion = 0;
                        
                        this.showFeedback('success', 'Questions Generated!', 
                            `Generated ${aiQuestions.length} AI questions. Starting practice...`);
                        
                        this.displayCurrentQuestion();
                    } else {
                        throw new Error('No questions generated');
                    }
                } catch (error) {
                    console.error('Failed to generate AI questions:', error);
                    this.showFeedback('error', 'Generation Failed', 
                        'Failed to generate questions: ' + error.message);
                }
            }

            loadQuestions() {
                // Default questions for when AI is not available
                this.questions = [
                    {
                        text: '‰Ω†Â•ΩÔºåÂæàÈ´òÂÖ¥ËÆ§ËØÜ‰Ω†„ÄÇ‰Ω†Â•ΩÂêóÔºü',
                        expected_answer: 'ÊàëÂæàÂ•ΩÔºåË∞¢Ë∞¢„ÄÇ‰Ω†Âë¢Ôºü',
                        category: 'greeting',
                        context: 'meeting someone new'
                    },
                    {
                        text: '‰Ω†Âè´‰ªÄ‰πàÂêçÂ≠óÔºü',
                        expected_answer: 'ÊàëÂè´...',
                        category: 'introduction',
                        context: 'personal introduction'
                    },
                    {
                        text: '‰Ω†Êù•Ëá™Âì™ÈáåÔºü',
                        expected_answer: 'ÊàëÊù•Ëá™...',
                        category: 'origin',
                        context: 'talking about background'
                    },
                    {
                        text: '‰Ω†Â§öÂ§ßÂπ¥Á∫™Ôºü',
                        expected_answer: 'Êàë...Â≤Å',
                        category: 'age',
                        context: 'personal information'
                    },
                    {
                        text: '‰Ω†Âú®ÂÅö‰ªÄ‰πàÂ∑•‰ΩúÔºü',
                        expected_answer: 'ÊàëÊòØ.../ÊàëÂÅö...',
                        category: 'work',
                        context: 'career discussion'
                    }
                ];
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new ChinesePracticeApp();
            
            // Auto-test connection if API key is present
            setTimeout(() => {
                const apiKeyInput = document.getElementById('apiKeyInput');
                if (apiKeyInput.value.trim()) {
                    console.log('Auto-testing connection with provided API key...');
                    window.app.testMiniMaxConnection();
                }
            }, 1000);
        });
    </script>
</body>
</html>