<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»ƒä¹ ä¸­æ–‡ - Chinese Mandarin Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .app-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .question-section {
            margin-bottom: 30px;
        }

        .question-text {
            font-size: 1.4em;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            min-height: 60px;
        }

        .question-audio {
            text-align: center;
            margin-bottom: 20px;
        }

        .audio-btn {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1em;
            margin: 0 10px;
            transition: all 0.3s ease;
        }

        .audio-btn:hover {
            background: #45b7aa;
            transform: translateY(-2px);
        }

        .audio-btn.recording {
            background: #ff6b6b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .answer-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .answer-display {
            min-height: 80px;
            font-size: 1.5em;
            text-align: center;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
        }

        .answer-display.has-text {
            border-color: #28a745;
            background: #f8fff9;
        }

        .correct {
            color: #28a745;
        }

        .incorrect {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            border-radius: 5px;
            padding: 2px 4px;
        }

        .needs-improvement {
            color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 5px;
            padding: 2px 4px;
        }

        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        .record-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .record-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .record-btn.stop {
            background: #dc3545;
        }

        .feedback {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .feedback.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .feedback.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .feedback.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .feedback h3 {
            margin-bottom: 10px;
        }

        .next-question {
            text-align: center;
        }

        .next-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .next-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .score {
            background: #6f42c1;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
        }

        .question-count {
            background: #fd7e14;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
        }

        .character-prompt {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2em;
        }

        @media (max-width: 600px) {
            .main-content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .answer-display {
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>ç»ƒä¹ ä¸­æ–‡</h1>
            <p>Chinese Mandarin Practice - HSK 1 & 2</p>
        </div>

        <div class="main-content">
            <div class="progress">
                <div class="score">Score: <span id="score">0</span></div>
                <div class="question-count">Question <span id="currentQuestion">1</span>/20</div>
            </div>

            <div class="question-section">
                <div id="questionText" class="question-text"></div>
                <div class="character-prompt" id="characterPrompt"></div>
                <div class="question-audio">
                    <button class="audio-btn" id="playAudio">ğŸ”Š Play Question Audio</button>
                    <button class="audio-btn" id="repeatQuestion">ğŸ”„ Repeat Question</button>
                </div>
            </div>

            <div class="answer-section">
                <div id="answerDisplay" class="answer-display">ç‚¹å‡»å¼€å§‹å½•éŸ³è¯´ä¸­æ–‡ (Click to start recording in Chinese)</div>
                <div class="controls">
                    <button class="record-btn" id="startRecording">ğŸ¤ Start Recording</button>
                </div>
            </div>

            <div id="feedback" class="feedback" style="display: none;"></div>

            <div class="next-question">
                <button class="next-btn" id="nextQuestion" style="display: none;">Next Question â†’</button>
            </div>
        </div>
    </div>

    <script>
        class ChinesePracticeApp {
            constructor() {
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.totalQuestions = 20;
                this.isRecording = false;
                this.recognition = null;
                this.currentTranscript = '';
                
                this.initializeSpeechRecognition();
                this.initializeQuestions();
                this.loadCurrentQuestion();
                this.setupEventListeners();
            }

            initializeSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    
                    this.recognition.continuous = true;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'zh-CN';
                    this.recognition.maxAlternatives = 3;

                    this.recognition.onstart = () => {
                        this.isRecording = true;
                        this.updateRecordingButton();
                    };

                    this.recognition.onresult = (event) => {
                        let finalTranscript = '';
                        let interimTranscript = '';

                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript;
                            } else {
                                interimTranscript += transcript;
                            }
                        }

                        this.currentTranscript = finalTranscript || interimTranscript;
                        this.updateAnswerDisplay();
                    };

                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.showFeedback('error', 'Recording Error', 'Please try speaking again or check your microphone.');
                        this.stopRecording();
                    };

                    this.recognition.onend = () => {
                        if (this.isRecording) {
                            // Auto-restart if still recording
                            this.recognition.start();
                        }
                    };
                } else {
                    this.showFeedback('error', 'Speech Recognition Not Supported', 
                        'Your browser does not support speech recognition. Please use Chrome or another modern browser.');
                }
            }

            initializeQuestions() {
                this.questions = [
                    {
                        type: 'greeting',
                        question: 'ä½ å¥½ï¼ä½ å¥½å—ï¼Ÿ',
                        characterPrompt: 'ç”¨ä¸­æ–‡å›ç­”é—®å€™ (Answer the greeting in Chinese)',
                        expected: ['æˆ‘å¾ˆå¥½', 'å¾ˆå¥½', 'æˆ‘å¾ˆå¥½ï¼Œè°¢è°¢', 'å¾ˆå¥½ï¼Œè°¢è°¢'],
                        natural_responses: [
                            { text: 'æˆ‘å¾ˆå¥½', natural: true },
                            { text: 'å¾ˆå¥½', natural: true },
                            { text: 'æˆ‘éå¸¸å¥½', natural: false }, // Less common
                            { text: 'ä¸å¥½', natural: true },
                            { text: 'ä¸€èˆ¬èˆ¬', natural: true }
                        ],
                        audioText: 'ä½ å¥½ï¼ä½ å¥½å—ï¼Ÿ'
                    },
                    {
                        type: 'introduction',
                        question: 'è¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚',
                        characterPrompt: 'ä»‹ç»ä½ çš„åå­—å’ŒåŸºæœ¬ä¿¡æ¯ (Introduce your name and basic info)',
                        expected: ['æˆ‘å«', 'æˆ‘çš„åå­—æ˜¯', 'æˆ‘æ˜¯'],
                        natural_responses: [
                            { text: 'æˆ‘å«å¼ ä¸‰', natural: true },
                            { text: 'æˆ‘çš„åå­—æ˜¯ææ˜', natural: true },
                            { text: 'æˆ‘æ˜¯ä¸­å›½äºº', natural: true },
                            { text: 'æˆ‘çš„åç§°æ˜¯ç‹ä¼Ÿ', natural: false }, // Less natural
                            { text: 'æˆ‘æ˜¯ä¸€ä¸ªå­¦ç”Ÿ', natural: true }
                        ],
                        audioText: 'è¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚'
                    },
                    {
                        type: 'family',
                        question: 'ä½ æœ‰å…„å¼Ÿå§å¦¹å—ï¼Ÿ',
                        characterPrompt: 'ä»‹ç»ä½ çš„å®¶åº­ (Talk about your family)',
                        expected: ['æˆ‘æœ‰ä¸€ä¸ª', 'æˆ‘æ²¡æœ‰', 'æˆ‘æœ‰'],
                        natural_responses: [
                            { text: 'æˆ‘æœ‰ä¸€ä¸ªå“¥å“¥', natural: true },
                            { text: 'æˆ‘æ²¡æœ‰å…„å¼Ÿå§å¦¹', natural: true },
                            { text: 'æˆ‘æœ‰ä¸€ä¸ªå¦¹å¦¹', natural: true },
                            { text: 'æˆ‘å®¶æœ‰ä¸‰ä¸ªå­©å­', natural: true },
                            { text: 'æˆ‘æ˜¯ç‹¬ç”Ÿå­å¥³', natural: true }
                        ],
                        audioText: 'ä½ æœ‰å…„å¼Ÿå§å¦¹å—ï¼Ÿ'
                    },
                    {
                        type: 'age',
                        question: 'ä½ å¤šå¤§äº†ï¼Ÿ',
                        characterPrompt: 'è¯´å‡ºä½ çš„å¹´é¾„ (Tell your age)',
                        expected: ['æˆ‘', 'å²'],
                        natural_responses: [
                            { text: 'æˆ‘äºŒåå²', natural: true },
                            { text: 'æˆ‘äºŒåäº”å²', natural: true },
                            { text: 'æˆ‘ä»Šå¹´ä¸‰åå²', natural: true },
                            { text: 'æˆ‘çš„å¹´é¾„æ˜¯äºŒåå…«', natural: false }, // Less natural
                            { text: 'æˆ‘å·²ç»åå…«å²äº†', natural: true }
                        ],
                        audioText: 'ä½ å¤šå¤§äº†ï¼Ÿ'
                    },
                    {
                        type: 'nationality',
                        question: 'ä½ æ¥è‡ªå“ªé‡Œï¼Ÿ',
                        characterPrompt: 'è¯´å‡ºä½ çš„å›½ç±æˆ–å‡ºç”Ÿåœ° (Say your nationality or birthplace)',
                        expected: ['æˆ‘æ¥è‡ª', 'æˆ‘æ˜¯', 'åœ¨'],
                        natural_responses: [
                            { text: 'æˆ‘æ¥è‡ªåŒ—äº¬', natural: true },
                            { text: 'æˆ‘æ˜¯ä¸­å›½äºº', natural: true },
                            { text: 'æˆ‘åœ¨ä¸Šæµ·å‡ºç”Ÿ', natural: true },
                            { text: 'æˆ‘çš„ç¥–å›½æ˜¯ä¸­å›½', natural: true },
                            { text: 'æˆ‘æ˜¯ä¸€ä¸ªä¸­å›½äºº', natural: true }
                        ],
                        audioText: 'ä½ æ¥è‡ªå“ªé‡Œï¼Ÿ'
                    },
                    {
                        type: 'food',
                        question: 'ä½ å–œæ¬¢åƒä»€ä¹ˆï¼Ÿ',
                        characterPrompt: 'è¯´ä½ å–œæ¬¢çš„é£Ÿç‰© (Say what food you like)',
                        expected: ['æˆ‘å–œæ¬¢åƒ', 'æˆ‘å–œæ¬¢', 'æˆ‘å–œæ¬¢å–'],
                        natural_responses: [
                            { text: 'æˆ‘å–œæ¬¢åƒç±³é¥­', natural: true },
                            { text: 'æˆ‘å–œæ¬¢é¢æ¡', natural: true },
                            { text: 'æˆ‘å–œæ¬¢åƒè‹¹æœ', natural: true },
                            { text: 'æˆ‘æœ€çˆ±åƒé¥ºå­', natural: true },
                            { text: 'æˆ‘ä¸å¤ªå–œæ¬¢è¾£çš„é£Ÿç‰©', natural: true }
                        ],
                        audioText: 'ä½ å–œæ¬¢åƒä»€ä¹ˆï¼Ÿ'
                    },
                    {
                        type: 'hobby',
                        question: 'ä½ çš„çˆ±å¥½æ˜¯ä»€ä¹ˆï¼Ÿ',
                        characterPrompt: 'è¯´è¯´ä½ å–œæ¬¢åšçš„äº‹æƒ… (Tell what you like to do)',
                        expected: ['æˆ‘å–œæ¬¢', 'æˆ‘çš„çˆ±å¥½æ˜¯', 'æˆ‘å–œæ¬¢åš'],
                        natural_responses: [
                            { text: 'æˆ‘å–œæ¬¢è¯»ä¹¦', natural: true },
                            { text: 'æˆ‘çš„çˆ±å¥½æ˜¯æ¸¸æ³³', natural: true },
                            { text: 'æˆ‘å–œæ¬¢å¬éŸ³ä¹', natural: true },
                            { text: 'æˆ‘çˆ±è¸¢è¶³çƒ', natural: true },
                            { text: 'æˆ‘ç‰¹åˆ«å–œæ¬¢æ‹ç…§', natural: true }
                        ],
                        audioText: 'ä½ çš„çˆ±å¥½æ˜¯ä»€ä¹ˆï¼Ÿ'
                    },
                    {
                        type: 'weather',
                        question: 'ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ',
                        characterPrompt: 'æè¿°ä»Šå¤©çš„å¤©æ°” (Describe today\'s weather)',
                        expected: ['ä»Šå¤©', 'å¤©æ°”', 'å¾ˆ', 'ä¸é”™', 'ä¸å¥½', 'æ™´å¤©', 'ä¸‹é›¨'],
                        natural_responses: [
                            { text: 'ä»Šå¤©å¤©æ°”å¾ˆå¥½', natural: true },
                            { text: 'ä»Šå¤©å¾ˆçƒ­', natural: true },
                            { text: 'ä»Šå¤©åœ¨ä¸‹é›¨', natural: true },
                            { text: 'ä»Šå¤©æœ‰ç‚¹å†·', natural: true },
                            { text: 'ä»Šå¤©é˜³å…‰æ˜åªš', natural: true }
                        ],
                        audioText: 'ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ'
                    },
                    {
                        type: 'time',
                        question: 'ç°åœ¨å‡ ç‚¹äº†ï¼Ÿ',
                        characterPrompt: 'è¯´å‡ºå½“å‰æ—¶é—´ (Tell the current time)',
                        expected: ['ç°åœ¨', 'ç‚¹', 'åˆ†'],
                        natural_responses: [
                            { text: 'ç°åœ¨ä¸‰ç‚¹åŠ', natural: true },
                            { text: 'ç°åœ¨æ˜¯ä¸‹åˆä¸¤ç‚¹', natural: true },
                            { text: 'ç°åœ¨åç‚¹æ•´', natural: true },
                            { text: 'ç°åœ¨ä¸­åˆåäºŒç‚¹', natural: true },
                            { text: 'ç°åœ¨æ™šä¸Šå…«ç‚¹', natural: true }
                        ],
                        audioText: 'ç°åœ¨å‡ ç‚¹äº†ï¼Ÿ'
                    },
                    {
                        type: 'work',
                        question: 'ä½ çš„å·¥ä½œæ˜¯ä»€ä¹ˆï¼Ÿ',
                        characterPrompt: 'è¯´è¯´ä½ çš„èŒä¸š (Talk about your job)',
                        expected: ['æˆ‘æ˜¯', 'æˆ‘çš„å·¥ä½œæ˜¯', 'æˆ‘åœ¨'],
                        natural_responses: [
                            { text: 'æˆ‘æ˜¯ä¸€åè€å¸ˆ', natural: true },
                            { text: 'æˆ‘çš„å·¥ä½œæ˜¯å·¥ç¨‹å¸ˆ', natural: true },
                            { text: 'æˆ‘åœ¨åŒ»é™¢å·¥ä½œ', natural: true },
                            { text: 'æˆ‘æ˜¯å­¦ç”Ÿ', natural: true },
                            { text: 'æˆ‘æ˜¯ä¸€ä¸ªåŒ»ç”Ÿ', natural: true }
                        ],
                        audioText: 'ä½ çš„å·¥ä½œæ˜¯ä»€ä¹ˆï¼Ÿ'
                    },
                    {
                        type: 'color',
                        question: 'ä½ æœ€å–œæ¬¢ä»€ä¹ˆé¢œè‰²ï¼Ÿ',
                        characterPrompt: 'è¯´å‡ºä½ å–œæ¬¢çš„é¢œè‰² (Say your favorite color)',
                        expected: ['æˆ‘å–œæ¬¢', 'æˆ‘æœ€å–œæ¬¢', 'é¢œè‰²'],
                        natural_responses: [
                            { text: 'æˆ‘æœ€å–œæ¬¢è“è‰²', natural: true },
                            { text: 'æˆ‘å–œæ¬¢çº¢è‰²', natural: true },
                            { text: 'æˆ‘æœ€çˆ±é»‘è‰²', natural: true },
                            { text: 'æˆ‘å–œæ¬¢ç™½è‰²', natural: true },
                            { text: 'æˆ‘çš„é¢œè‰²åå¥½æ˜¯ç»¿è‰²', natural: false } // Less natural
                        ],
                        audioText: 'ä½ æœ€å–œæ¬¢ä»€ä¹ˆé¢œè‰²ï¼Ÿ'
                    },
                    {
                        type: 'direction',
                        question: 'å•æ‰€åœ¨å“ªé‡Œï¼Ÿ',
                        characterPrompt: 'æŒ‡å‡ºæ­£ç¡®çš„æ–¹å‘ (Give directions)',
                        expected: ['åœ¨', 'é‚£è¾¹', 'è¿™é‡Œ', 'å¾€', 'èµ°'],
                        natural_responses: [
                            { text: 'å•æ‰€åœ¨é‚£è¾¹', natural: true },
                            { text: 'ä»è¿™é‡Œå¾€å·¦èµ°', natural: true },
                            { text: 'å•æ‰€åœ¨äºŒæ¥¼', natural: true },
                            { text: 'è¯·è·Ÿæˆ‘æ¥', natural: true },
                            { text: 'åœ¨èµ°å»Šçš„å°½å¤´', natural: true }
                        ],
                        audioText: 'å•æ‰€åœ¨å“ªé‡Œï¼Ÿ'
                    },
                    {
                        type: 'shopping',
                        question: 'è¿™ä¸ªå¤šå°‘é’±ï¼Ÿ',
                        characterPrompt: 'é—®ä»·æ ¼æˆ–è¯´ä»·æ ¼ (Ask for or give price)',
                        expected: ['å—é’±', 'å…ƒ', 'å¤ªè´µ', 'ä¾¿å®œ', 'ä¹°'],
                        natural_responses: [
                            { text: 'è¿™ä¸ªåå—é’±', natural: true },
                            { text: 'å¤ªè´µäº†', natural: true },
                            { text: 'å¤ªä¾¿å®œäº†', natural: true },
                            { text: 'æˆ‘è¦ä¹°è¿™ä¸ª', natural: true },
                            { text: 'èƒ½ä¾¿å®œä¸€ç‚¹å—', natural: true }
                        ],
                        audioText: 'è¿™ä¸ªå¤šå°‘é’±ï¼Ÿ'
                    },
                    {
                        type: 'transportation',
                        question: 'ä½ æ€ä¹ˆæ¥çš„ï¼Ÿ',
                        characterPrompt: 'è¯´ä½ ç”¨çš„äº¤é€šå·¥å…· (Say how you travel)',
                        expected: ['æˆ‘å', 'æˆ‘å¼€è½¦', 'æˆ‘èµ°', 'å…¬äº¤è½¦', 'åœ°é“'],
                        natural_responses: [
                            { text: 'æˆ‘åå…¬äº¤è½¦æ¥çš„', natural: true },
                            { text: 'æˆ‘å¼€è½¦æ¥çš„', natural: true },
                            { text: 'æˆ‘èµ°è·¯æ¥çš„', natural: true },
                            { text: 'æˆ‘ååœ°é“', natural: true },
                            { text: 'æˆ‘éª‘è‡ªè¡Œè½¦', natural: true }
                        ],
                        audioText: 'ä½ æ€ä¹ˆæ¥çš„ï¼Ÿ'
                    },
                    {
                        type: 'feeling',
                        question: 'ä½ ç°åœ¨æ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿ',
                        characterPrompt: 'æè¿°ä½ çš„æ„Ÿå— (Describe how you feel)',
                        expected: ['æˆ‘æ„Ÿè§‰', 'æˆ‘å¾ˆ', 'ç´¯', 'é«˜å…´', 'éš¾è¿‡', 'ç´§å¼ '],
                        natural_responses: [
                            { text: 'æˆ‘æ„Ÿè§‰å¾ˆå¥½', natural: true },
                            { text: 'æˆ‘å¾ˆç´¯', natural: true },
                            { text: 'æˆ‘ä»Šå¤©å¾ˆå¼€å¿ƒ', natural: true },
                            { text: 'æˆ‘æœ‰ç‚¹ç´§å¼ ', natural: true },
                            { text: 'æˆ‘æœ‰ç‚¹é¥¿', natural: true }
                        ],
                        audioText: 'ä½ ç°åœ¨æ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿ'
                    },
                    {
                        type: 'language',
                        question: 'ä½ ä¼šè¯´è‹±è¯­å—ï¼Ÿ',
                        characterPrompt: 'è¯´è¯´ä½ çš„è¯­è¨€èƒ½åŠ› (Talk about your language abilities)',
                        expected: ['æˆ‘ä¼š', 'æˆ‘ä¸ä¼š', 'ä¼šè¯´', 'ä¸å¤ªä¼š', 'åªä¼šä¸€ç‚¹'],
                        natural_responses: [
                            { text: 'æˆ‘ä¼šè¯´ä¸€ç‚¹è‹±è¯­', natural: true },
                            { text: 'æˆ‘ä¸å¤ªä¼šè¯´è‹±è¯­', natural: true },
                            { text: 'æˆ‘åªä¼šä¸­æ–‡', natural: true },
                            { text: 'æˆ‘è‹±è¯­è¿˜å¯ä»¥', natural: true },
                            { text: 'æˆ‘ä¸ä¼šè¯´è‹±è¯­', natural: true }
                        ],
                        audioText: 'ä½ ä¼šè¯´è‹±è¯­å—ï¼Ÿ'
                    },
                    {
                        type: 'plan',
                        question: 'ä½ æ˜å¤©åšä»€ä¹ˆï¼Ÿ',
                        characterPrompt: 'è¯´è¯´æ˜å¤©çš„è®¡åˆ’ (Tell tomorrow\'s plans)',
                        expected: ['æ˜å¤©', 'æˆ‘è¦', 'è®¡åˆ’', 'å»'],
                        natural_responses: [
                            { text: 'æ˜å¤©æˆ‘è¦ä¸Šç­', natural: true },
                            { text: 'æ˜å¤©æˆ‘å»çœ‹ç”µå½±', natural: true },
                            { text: 'æ˜å¤©æˆ‘æœ‰ç©º', natural: true },
                            { text: 'æ˜å¤©æˆ‘è¦å­¦ä¹ ', natural: true },
                            { text: 'æ˜å¤©æˆ‘è¦ä¼‘æ¯', natural: true }
                        ],
                        audioText: 'ä½ æ˜å¤©åšä»€ä¹ˆï¼Ÿ'
                    },
                    {
                        type: 'place',
                        question: 'ä½ å®¶åœ¨å“ªé‡Œï¼Ÿ',
                        characterPrompt: 'è¯´æ˜ä½ çš„å±…ä½åœ° (Tell where you live)',
                        expected: ['æˆ‘å®¶åœ¨', 'æˆ‘ä½åœ¨', 'åœ°å€æ˜¯'],
                        natural_responses: [
                            { text: 'æˆ‘å®¶åœ¨ä¸Šæµ·', natural: true },
                            { text: 'æˆ‘ä½åœ¨åŒ—äº¬å¸‚', natural: true },
                            { text: 'æˆ‘ä½åœ¨éƒŠåŒº', natural: true },
                            { text: 'æˆ‘å®¶åœ¨å¸‚ä¸­å¿ƒ', natural: true },
                            { text: 'æˆ‘çš„å®¶åœ¨æ²³è¾¹', natural: true }
                        ],
                        audioText: 'ä½ å®¶åœ¨å“ªé‡Œï¼Ÿ'
                    },
                    {
                        type: 'comparison',
                        question: 'ä½ å’Œæœ‹å‹æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ',
                        characterPrompt: 'æ¯”è¾ƒè‡ªå·±å’Œæœ‹å‹ (Compare yourself to a friend)',
                        expected: ['æˆ‘æ¯”ä»–', 'æˆ‘ä»¬å·®ä¸å¤š', 'æˆ‘æ¯”å¥¹', 'ç›¸åŒ', 'ä¸åŒ'],
                        natural_responses: [
                            { text: 'æˆ‘æ¯”ä»–é«˜', natural: true },
                            { text: 'æˆ‘ä»¬å·®ä¸å¤š', natural: true },
                            { text: 'æˆ‘æ¯”å¥¹ç˜¦', natural: true },
                            { text: 'æˆ‘ä»¬çˆ±å¥½ä¸åŒ', natural: true },
                            { text: 'æˆ‘æ¯”ä»–å¹´è½»', natural: true }
                        ],
                        audioText: 'ä½ å’Œæœ‹å‹æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ'
                    },
                    {
                        type: 'health',
                        question: 'ä½ æœ€è¿‘èº«ä½“æ€ä¹ˆæ ·ï¼Ÿ',
                        characterPrompt: 'è°ˆè®ºå¥åº·çŠ¶å†µ (Talk about health)',
                        expected: ['æˆ‘æœ€è¿‘', 'èº«ä½“', 'å¥åº·', 'ä¸èˆ’æœ', 'æ„Ÿå†’'],
                        natural_responses: [
                            { text: 'æˆ‘æœ€è¿‘èº«ä½“å¾ˆå¥½', natural: true },
                            { text: 'æˆ‘æœ€è¿‘æœ‰ç‚¹æ„Ÿå†’', natural: true },
                            { text: 'æˆ‘æœ€è¿‘ç¡çœ ä¸å¥½', natural: true },
                            { text: 'æˆ‘æœ€è¿‘åœ¨é”»ç‚¼', natural: true },
                            { text: 'æˆ‘æœ€è¿‘å¾ˆå¿™', natural: true }
                        ],
                        audioText: 'ä½ æœ€è¿‘èº«ä½“æ€ä¹ˆæ ·ï¼Ÿ'
                    }
                ];
            }

            setupEventListeners() {
                document.getElementById('startRecording').addEventListener('click', () => {
                    this.toggleRecording();
                });

                document.getElementById('nextQuestion').addEventListener('click', () => {
                    this.nextQuestion();
                });

                document.getElementById('playAudio').addEventListener('click', () => {
                    this.playQuestionAudio();
                });

                document.getElementById('repeatQuestion').addEventListener('click', () => {
                    this.playQuestionAudio();
                });
            }

            loadCurrentQuestion() {
                if (this.currentQuestionIndex >= this.totalQuestions) {
                    this.showFinalScore();
                    return;
                }

                const question = this.questions[this.currentQuestionIndex];
                
                document.getElementById('questionText').textContent = question.question;
                document.getElementById('characterPrompt').textContent = question.characterPrompt;
                document.getElementById('currentQuestion').textContent = this.currentQuestionIndex + 1;
                
                this.hideFeedback();
                this.resetRecordingState();
                this.currentTranscript = '';
                this.updateAnswerDisplay();
            }

            playQuestionAudio() {
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(this.questions[this.currentQuestionIndex].audioText);
                    utterance.lang = 'zh-CN';
                    utterance.rate = 0.8;
                    speechSynthesis.speak(utterance);
                } else {
                    this.showFeedback('error', 'Audio Not Supported', 'Your browser does not support speech synthesis.');
                }
            }

            toggleRecording() {
                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    this.startRecording();
                }
            }

            startRecording() {
                if (this.recognition) {
                    try {
                        this.recognition.start();
                        document.getElementById('answerDisplay').textContent = 'æ­£åœ¨å½•éŸ³... è¯´ä¸­æ–‡';
                        document.getElementById('answerDisplay').classList.add('has-text');
                    } catch (error) {
                        console.error('Error starting recognition:', error);
                        this.showFeedback('error', 'Recording Failed', 'Please try again.');
                    }
                }
            }

            stopRecording() {
                if (this.recognition && this.isRecording) {
                    this.recognition.stop();
                    this.isRecording = false;
                    this.updateRecordingButton();
                    
                    // Give a moment for final results, then analyze
                    setTimeout(() => {
                        this.analyzeAnswer();
                    }, 1000);
                }
            }

            updateRecordingButton() {
                const btn = document.getElementById('startRecording');
                if (this.isRecording) {
                    btn.textContent = 'â¹ï¸ Stop Recording';
                    btn.classList.add('stop');
                } else {
                    btn.textContent = 'ğŸ¤ Start Recording';
                    btn.classList.remove('stop');
                }
            }

            updateAnswerDisplay() {
                const display = document.getElementById('answerDisplay');
                if (this.currentTranscript) {
                    display.textContent = this.currentTranscript;
                    display.classList.add('has-text');
                } else {
                    display.textContent = 'ç‚¹å‡»å¼€å§‹å½•éŸ³è¯´ä¸­æ–‡ (Click to start recording in Chinese)';
                    display.classList.remove('has-text');
                }
            }

            analyzeAnswer() {
                const answer = this.currentTranscript.trim();
                const question = this.questions[this.currentQuestionIndex];
                
                if (!answer) {
                    this.showFeedback('error', 'No Answer Detected', 'Please try recording your answer again.');
                    return;
                }

                const analysis = this.compareAnswers(answer, question);
                this.displayAnalysis(analysis, question);
                
                if (analysis.isCorrect) {
                    this.score += 10;
                    document.getElementById('score').textContent = this.score;
                }

                document.getElementById('nextQuestion').style.display = 'block';
            }

            compareAnswers(userAnswer, question) {
                let isCorrect = false;
                let isNatural = false;
                let errors = [];
                let improvements = [];

                // Check if answer contains expected keywords
                const hasExpected = question.expected.some(expected => 
                    userAnswer.includes(expected)
                );

                // Check for natural responses
                for (let response of question.natural_responses) {
                    if (userAnswer.includes(response.text)) {
                        isCorrect = hasExpected;
                        isNatural = response.natural;
                        break;
                    }
                }

                // If no exact match, consider partially correct
                if (!isCorrect && hasExpected) {
                    isCorrect = true;
                }

                // Analyze pronunciation issues (basic detection)
                const commonMispronunciations = {
                    'zh': 'z', 'ch': 'c', 'sh': 's',
                    'r': 'l', 'n': 'l', 'en': 'eng'
                };

                // Simple error detection
                if (userAnswer.length < 2) {
                    errors.push('Answer too short');
                }

                // Check for unnatural expressions
                if (isCorrect && !isNatural) {
                    improvements.push('Consider using more natural expressions');
                }

                return {
                    isCorrect,
                    isNatural,
                    errors,
                    improvements,
                    userAnswer
                };
            }

            displayAnalysis(analysis, question) {
                const feedback = document.getElementById('feedback');
                let feedbackHTML = '';
                let feedbackClass = '';

                if (analysis.isCorrect && analysis.isNatural) {
                    feedbackClass = 'success';
                    feedbackHTML = `
                        <h3>âœ… å›ç­”å¾ˆå¥½ï¼Excellent Answer!</h3>
                        <p>ä½ çš„å›ç­”è‡ªç„¶æµç•…ï¼Œè¡¨è¾¾åœ°é“ã€‚</p>
                        <p><strong>ä½ çš„å›ç­”:</strong> ${this.highlightText(analysis.userAnswer, 'correct')}</p>
                    `;
                } else if (analysis.isCorrect) {
                    feedbackClass = 'warning';
                    feedbackHTML = `
                        <h3>âš ï¸ åŸºæœ¬æ­£ç¡®ï¼Œä½†æœ‰æ”¹è¿›ç©ºé—´ Mostly Correct</h3>
                        <p>ä½ çš„å›ç­”è¯­æ³•æ­£ç¡®ï¼Œä½†å¯ä»¥æ›´è‡ªç„¶ã€‚</p>
                        <p><strong>ä½ çš„å›ç­”:</strong> ${this.highlightText(analysis.userAnswer, 'needs-improvement')}</p>
                        ${analysis.improvements.length > 0 ? `<p><strong>å»ºè®®:</strong> ${analysis.improvements.join(', ')}</p>` : ''}
                        <p><strong>æ›´è‡ªç„¶çš„è¯´æ³•:</strong></p>
                        <ul>
                            ${question.natural_responses.filter(r => r.natural).map(r => `<li>${r.text}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    feedbackClass = 'error';
                    feedbackHTML = `
                        <h3>âŒ å›ç­”éœ€è¦æ”¹è¿› Answer Needs Work</h3>
                        <p>ä½ çš„å›ç­”å¯èƒ½éœ€è¦è°ƒæ•´ã€‚</p>
                        <p><strong>ä½ çš„å›ç­”:</strong> ${this.highlightText(analysis.userAnswer, 'incorrect')}</p>
                        ${analysis.errors.length > 0 ? `<p><strong>é—®é¢˜:</strong> ${analysis.errors.join(', ')}</p>` : ''}
                        <p><strong>å‚è€ƒå›ç­”:</strong></p>
                        <ul>
                            ${question.natural_responses.filter(r => r.natural).map(r => `<li>${r.text}</li>`).join('')}
                        </ul>
                    `;
                }

                feedback.innerHTML = feedbackHTML;
                feedback.className = `feedback ${feedbackClass}`;
                feedback.style.display = 'block';
            }

            highlightText(text, type) {
                // Simple highlighting - in a real app, this would be more sophisticated
                const colors = {
                    'correct': '#28a745',
                    'incorrect': '#dc3545',
                    'needs-improvement': '#ffc107'
                };
                return `<span style="color: ${colors[type]}">${text}</span>`;
            }

            nextQuestion() {
                this.currentQuestionIndex++;
                this.loadCurrentQuestion();
                document.getElementById('nextQuestion').style.display = 'none';
            }

            showFinalScore() {
                const percentage = Math.round((this.score / (this.totalQuestions * 10)) * 100);
                let message = '';
                let emoji = '';

                if (percentage >= 80) {
                    message = 'å¤ªæ£’äº†ï¼ä½ è¿›æ­¥å¾ˆå¤§ï¼';
                    emoji = 'ğŸ‰';
                } else if (percentage >= 60) {
                    message = 'ä¸é”™ï¼ç»§ç»­ç»ƒä¹ ï¼';
                    emoji = 'ğŸ‘';
                } else {
                    message = 'åˆ«ç°å¿ƒï¼Œå¤šç»ƒä¹ å°±ä¼šè¿›æ­¥ï¼';
                    emoji = 'ğŸ’ª';
                }

                document.getElementById('questionText').innerHTML = `
                    <h2>${emoji} ç»ƒä¹ å®Œæˆï¼Practice Complete!</h2>
                    <p>æ€»åˆ†: ${this.score}/${this.totalQuestions * 10} (${percentage}%)</p>
                    <p>${message}</p>
                `;
                
                document.getElementById('characterPrompt').textContent = 'æ­å–œå®Œæˆç»ƒä¹ ï¼å¯ä»¥é‡æ–°å¼€å§‹æˆ–åˆ·æ–°é¡µé¢ã€‚';
                document.getElementById('feedback').style.display = 'none';
                document.getElementById('nextQuestion').style.display = 'none';
            }

            showFeedback(type, title, message) {
                const feedback = document.getElementById('feedback');
                feedback.innerHTML = `
                    <h3>${title}</h3>
                    <p>${message}</p>
                `;
                feedback.className = `feedback ${type}`;
                feedback.style.display = 'block';
            }

            hideFeedback() {
                document.getElementById('feedback').style.display = 'none';
            }

            resetRecordingState() {
                this.isRecording = false;
                this.updateRecordingButton();
            }
        }

        // Initialize the app when the page loads
        window.addEventListener('load', () => {
            new ChinesePracticeApp();
        });
    </script>
</body>
</html>